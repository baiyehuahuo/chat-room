# chat-room
Go语言编程之旅 -- 聊天室模拟

## 基于TCP的聊天室
1. 服务端开启监听某个端口，接收来自客户端的连接
2. 封装客户端信息，客户端读写线程开启前后做一些特殊处理。
   - 比如说监听客户端活跃情况
   - 比如说发送客户端进入/退出消息
3. 为每个客户端开启两个线程，一个用于读，一个用于写。

## Websocket 介绍、握手和细节
1. 介绍
   - WebSocket 是一种网络传输协议，可在单个 TCP 连接上进行全双工通信，位于 OSI 模型的应用层。
   - Websocket 使客户端和服务器之间的数据交换变得简单，允许服务端主动向客户端推送数据。
   - Websocket API 中 浏览器与服务器只需要完成一次握手，亮着就可以创建持久性的连接，并进行双向数据传输
2. 优点
   - 较少地控制开销： 连接建立后，服务端和客户端交换数据时，用于协议控制等的数据包头部较小
   - 更强的实时性： 协议是全双工的，服务器可以随时主动给客户端下发数据
   - 保持连接状态
   - 更好的二进制支持： Websocket 定义了二进制帧，相对于HTTP可以更轻松地处理二进制内容
   - 可以支持扩展
   - 更好地压缩效果

## 聊天室需求分析和设计
1. 聊天室的主要功能
   - 在线人数、在线列表
   - 昵称、头像
   - 接收/发送消息
   - 进入/退出聊天室
   - 不同消息类型的支持
   - 敏感词过滤
   - 黑名单
   - 聊天室信息
   - 创建/修改聊天室
   - 聊天室信息存储和历史消息查询
2. ![聊天室的交互流程](https://golang2.eddycjy.com/images/ch4/chatroom-design.png)

## 项目组织和基本代码框架
1. 目录分层
   - cmd: 约定俗成，存放 main.main
   - logic: 存放项目核心代码逻辑， 与 service 呈类似作用
   - server: 存放 server 相关代码，类似于 controller
   - template: 存放静态模板文件
2. 主线程注册路由，开启处理用的子线程，启动服务监听端口

## 用户核心流程
1. 递归寻找根目录， 利用template包解析 html 代码， 渲染前端
2. 启动处理用的子线程，如广播消息
3. 检测用户入参是否正确
4. 创建用户实例
5. 将用户实例加入广播序列中
6. 启动给用户发送消息的线程
7. 监听用户发送来的信息
8. 处理用户退出事项

## 广播核心流程
1. 单一实例的广播器，提前加载
2. 定义消息类型
3. 广播器处理来自用户的各种消息

## 非核心功能
1. 提醒功能
   - 根据输入的 content 检测标识符
   - 根据标识符后的参数 指定提醒对象
2. 敏感词处理
   - 简单替换或正则替换
   - DFA 又穷自动机
   - 朴素贝叶斯
   - 注意中文要先转换为 rune 才能准确获取长度
3. 离线消息处理
   - 识别同一个用户： 通过token。 token生成：
     - 基于 HMAC-SHA256
     - nickname+secret+uid 构成待 hash 的字符串，记为：message
     - 将 message 使用 HMAC-SHA256 计算 hash，记为：messageMAC
     - 将 messageMAC 使用 base64 进行处理，记为：messageMACStr 
     - messageMACStr+“uid”+uid 就是 token
     - 就是签名
   - 离线消息
     - 通过go容器中的 ring 实现，代码很短，大概看了一下